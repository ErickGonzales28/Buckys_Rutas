<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa de Rutas ‚Äî Fuerza de Ventas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./leaflet.css" />
  <script src="./leaflet.js"></script>
  <style>
    html, body, #map { height: 100%;
margin: 0; }
    :root {
      --card-bg: rgba(255,255,255,0.95);
      --accent: #E33111;
/* rojo puntos/pol√≠gonos */
      --label-bg: rgba(0,102,255,0.9);
      --shadow: 0 2px 10px rgba(0,0,0,.15);
      --radius: 12px;
--font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    /* Panel de filtros */
    .filters {
      position: absolute;
top: 10px; right: 10px; z-index: 1000;
      background: var(--card-bg); padding: 12px; border-radius: var(--radius);
      box-shadow: var(--shadow); max-width: 300px; font-family: var(--font);
      backdrop-filter: blur(4px);
}
    .filters h3 { margin: 0 0 8px; font-size: 14px;
}
    .filters label { display: block; margin: 6px 0 4px; font-size: 12px; color: #444;
}
    .filters select { width: 100%; padding: 6px; border-radius: 8px; border: 1px solid #ccc;
}
    .filters .row { display: grid; grid-template-columns: 1fr; gap: 8px;
}
    .filters .actions { display: flex; gap: 8px; margin-top: 8px;
}
    .filters button {
      border: 0; border-radius: 10px; padding: 8px 10px;
cursor: pointer; font-weight: 600;
    }
    .btn-apply { background: #005af0; color: #fff;
}
    .btn-clear { background: #eee; color: #333;
}
    /* Indicador de zoom */
    .zoom-indicator {
      position: absolute;
left: 10px; top: 90px; z-index: 1000;
      background: rgba(255,255,255,.9); border-radius: 8px; padding: 6px 8px;
      font: 12px/1.2 var(--font); color: #222; box-shadow: var(--shadow);
}
    /* Bot√≥n de mi ubicaci√≥n */
    .locate-control {
      position: absolute;
left: 10px; top: 140px; z-index: 1000;
      background: #fff; border-radius: 8px; box-shadow: var(--shadow);
      overflow: hidden;
}
    .locate-control button {
      border: 0; background: #fff; padding: 8px; width: 36px;
height: 36px; cursor: pointer;
    }
    .locate-control button:hover { background: #f2f2f2;
}
    /* Estilos de puntos y etiquetas */
    .label {
      background: transparent;
color: rgba(0,102,255,0.9);
      padding: 0 3px;
      margin: 0;
      border-radius: 3px;
white-space: nowrap;
      font: 12px/1.1 var(--font);
      border: 0;
      font-weight: bold;
      box-shadow: none;
display: inline-block;
      pointer-events: none;
}
    .leaflet-div-icon {
      background: transparent !important;
border: 0 !important;
      box-shadow: none !important;
    }
    .filters.hidden { display: none;
}
    .filters-toggle {
      position: absolute;
top: 10px; right: 10px; z-index: 1100;
      background: #005af0; color: #fff; border: 0; border-radius: 10px;
      padding: 8px 10px; box-shadow: var(--shadow);
font-family: var(--font);
      cursor: pointer;
    }
    .legend {
      position: absolute;
bottom: 10px; left: 10px; z-index: 1000;
      background: var(--card-bg); padding: 8px 10px; border-radius: 8px;
      box-shadow: var(--shadow); font: 12px var(--font);
}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="filters">
    <h3>Filtros</h3>
    <div class="row">
      <label for="f-dep">Departamento</label>
      <select id="f-dep" multiple></select>
      <label for="f-prov">Provincia</label>
      <select id="f-prov" multiple></select>
      <label for="f-dist">Distrito</label>
      <select id="f-dist" multiple></select>
      <label for="f-ruta">Ruta</label>
      <select id="f-ruta" multiple></select>
    </div>
    <div class="actions">
      [cite_start]<button class="btn-apply" id="applyFilters">Aplicar</button> [cite: 31]
      [cite_start]<button class="btn-clear" id="clearFilters">Limpiar</button> [cite: 31]
    </div>
    <small style="display:block;margin-top:6px;color:#666">Ctrl/Cmd+clic para seleccionar varios</small>
  </div>
  <button id="filterToggle" class="filters-toggle">Ocultar filtros</button>
  <div class="zoom-indicator">Zoom: <span id="zoomLevel">‚Äî</span></div>
  <div class="locate-control"><button id="locateBtn" title="Mi ubicaci√≥n">üìç</button></div>
  <div class="legend">
    <div><span style="display:inline-block;width:10px;height:10px;background:#E33111;
border-radius:50%; margin-right:6px;"></span>Punto de venta</div>
    <div><span style="display:inline-block;width:12px;height:12px;border:2px solid #E33111; background: rgba(227,49,17,0.10);
margin-right:6px;"></span>Pol√≠gono de ruta</div>
    <div><span style="display:inline-block;width:12px;height:2px;background:#444; display:inline-block; margin-right:6px;
vertical-align:middle;"></span>L√≠nea a etiqueta</div>
  </div>

<script>
  // === Cargar configuraci√≥n desde config.json ===
  fetch('./config.json')
    .then(r => r.json())
    .then(config => {
      const prefix   = config.prefix;
      const datetime = config.datetime;
      const naming   = config.naming;
      const pointsFile = naming.public_points.replace('{prefix}', prefix).replace('{datetime}', datetime);
      [cite_start]const polysFile = naming.public_polygons.replace('{prefix}', prefix).replace('{datetime}', datetime); [cite: 35]
      const POINTS_URL = encodeURI(`./data/${pointsFile}`);
      const POLYS_URL  = encodeURI(`./data/${polysFile}`);
      console.log("Cargando puntos desde:", POINTS_URL);
      console.log("Cargando pol√≠gonos desde:", POLYS_URL);
      initMap(POINTS_URL, POLYS_URL);
    [cite_start]}) [cite: 36]
    [cite_start].catch(err => console.error("Error cargando config.json:", err)); [cite: 37]

  // ================== Funci√≥n de inicializaci√≥n ==================
  function initMap(POINTS_URL, POLYS_URL) {
    [cite_start]const ZOOM_SHOW_POLYGONS = 14; [cite: 38]
    [cite_start]const ZOOM_SHOW_LABELS   = 17; [cite: 38]
    [cite_start]const map = L.map('map', { zoomControl: true }); [cite: 39]
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    [cite_start]let polygonsLayer; [cite: 40]
    [cite_start]const pointsLayer = L.layerGroup(); [cite: 40]
    [cite_start]const labelsLayer = L.layerGroup(); [cite: 40]
    [cite_start]const linesLayer  = L.layerGroup(); [cite: 40]
    [cite_start]let allPointFeatures = []; [cite: 41]
    [cite_start]let allPolyFeatures  = []; [cite: 41]
    [cite_start]const labelItems     = []; [cite: 42]

    Promise.all([
        fetch(POLYS_URL).then(r => r.json()),
        fetch(POINTS_URL).then(r => r.json())
    ])
    .then(([polysGeo, pointsGeo]) => {
        // --- 1. PROCESAR POL√çGONOS ---
        allPolyFeatures = polysGeo.features || [];
        polygonsLayer = L.geoJSON(polysGeo, {
          style: () => ({ color: '#E33111', weight: 2, fillColor: '#E33111', fillOpacity: 0.10 })
        }).addTo(map);
        polygonsLayer.eachLayer(layer => { layer._visibleByFilter = true; });
        if (polygonsLayer.getLayers().length > 0) {
          map.fitBounds(polygonsLayer.getBounds(), { padding: [20,20] });
        }
        togglePolygonsByZoom();

        // --- 2. PROCESAR PUNTOS ---
        allPointFeatures = pointsGeo.features || [];
        for (const f of allPointFeatures) {
          if (!f || !f.geometry || !f.geometry.coordinates) continue;
          const [lng, lat] = f.geometry.coordinates;
          const props = f.properties || {};
          const idText = String(props.ID ?? [cite_start]''); [cite: 45]
          const marker = L.circleMarker([lat, lng], {
            radius: 5, color: '#E33111', weight: 2, fillColor: '#E33111', fillOpacity: 0.9
          }).addTo(pointsLayer);
          const labelMarker = L.marker([lat, lng], {
            [cite_start]interactive: false, [cite: 46]
            icon: L.divIcon({ className: 'label', html: idText, iconSize: null, iconAnchor: [0, 0] })
          }).addTo(labelsLayer);
          const line = L.polyline([[lat, lng], [lat, lng]], { color: 'rgba(0,102,255,0.9)', weight: 1, opacity: 1 })
            [cite_start].addTo(linesLayer); [cite: 47]
          [cite_start]labelItems.push({ marker, labelMarker, line, props, lat, lng }); [cite: 47]
        }
        pointsLayer.addTo(map);
        labelsLayer.addTo(map);
        [cite_start]linesLayer.addTo(map); [cite: 48]
        if (!polygonsLayer || polygonsLayer.getLayers().length === 0) {
          if (pointsLayer.getLayers().length > 0) {
            map.fitBounds(pointsLayer.getBounds(), { padding: [50, 50] });
          } else {
            map.setView([-12.046374, -77.042793], 12); // Fallback a Lima
          }
        }

        // --- 3. POBLAR FILTROS Y CONFIGURAR EVENTOS (ahora que TODOS los datos est√°n cargados) ---
        [cite_start]const deps  = uniqueNonEmpty(allPointFeatures.map(f => f.properties?.Departamentos)); [cite: 80]
        [cite_start]const provs = uniqueNonEmpty(allPointFeatures.map(f => f.properties?.Provincias)); [cite: 80]
        [cite_start]const dists = uniqueNonEmpty(allPointFeatures.map(f => f.properties?.Distritos)); [cite: 80]
        [cite_start]const rutas = uniqueNonEmpty(allPointFeatures.map(f => f.properties?.Ruta)); [cite: 81]
        [cite_start]fillSelect(document.getElementById('f-dep'),  deps); [cite: 81]
        [cite_start]fillSelect(document.getElementById('f-prov'), provs); [cite: 81]
        [cite_start]fillSelect(document.getElementById('f-dist'), dists); [cite: 81]
        [cite_start]fillSelect(document.getElementById('f-ruta'), rutas); [cite: 81]

        [cite_start]document.getElementById('applyFilters').addEventListener('click', applyFilters); [cite: 98]
        [cite_start]document.getElementById('clearFilters').addEventListener('click', clearFilters); [cite: 98]

        map.on('zoomend moveend', () => {
          updateZoomIndicator();
          updateAllLabels();
          togglePolygonsByZoom();
        [cite_start]}); [cite: 99]
        updateZoomIndicator();
        updateAllLabels();
    })
    .catch(err => {
        console.error("Error fatal cargando datos GeoJSON:", err);
        alert("No se pudieron cargar los datos del mapa. Revise la consola para m√°s detalles.");
    });

    const CANDIDATE_OFFSETS = (function(){
        [cite_start]const SPIRAL_RADII = [14, 18, 22, 28, 34, 40]; [cite: 51]
        [cite_start]const SPIRAL_DIRS = [{x:1,y:-1},{x:-1,y:-1},{x:1,y:1},{x:-1,y:1},{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0}]; [cite: 52]
        [cite_start]const out = []; [cite: 53]
        [cite_start]for (const r of SPIRAL_RADII) for (const d of SPIRAL_DIRS) out.push({x: d.x * r, y: d.y * r}); [cite: 53]
        [cite_start]return out; [cite: 53]
    [cite_start]})(); [cite: 53]

    function getLabelSize(item) {
        [cite_start]const el = item.labelMarker.getElement(); [cite: 55]
        [cite_start]if (el && el.offsetWidth && el.offsetHeight) return { w: el.offsetWidth, h: el.offsetHeight }; [cite: 55]
        [cite_start]const text = String(item.props?.ID ?? ''); [cite: 56]
        [cite_start]const w = Math.max(18, text.length * 7 + 12); [cite: 56]
        [cite_start]const h = 18; [cite: 57]
        [cite_start]return { w, h }; [cite: 57]
    }

    function overlaps(a, b) {
      [cite_start]return !(a.x2 < b.x1 || a.x1 > b.x2 || a.y2 < b.y1 || a.y1 > b.y2); [cite: 58]
    }

    function placeLabelFor(item, placedBoxes) {
      [cite_start]const baseLL = L.latLng(item.lat, item.lng); [cite: 59]
      [cite_start]const basePx = map.project(baseLL, map.getZoom()); [cite: 59]
      [cite_start]const size   = getLabelSize(item); [cite: 60]
      for (const off of CANDIDATE_OFFSETS) {
        [cite_start]const candPx = L.point(basePx.x + off.x, basePx.y + off.y); [cite: 62]
        [cite_start]const candLL = map.unproject(candPx, map.getZoom()); [cite: 63]
        [cite_start]item.labelMarker.setLatLng(candLL); [cite: 64]
        [cite_start]const box = { x1: candPx.x, y1: candPx.y, x2: candPx.x + size.w, y2: candPx.y + size.h }; [cite: 65]
        [cite_start]let collide = false; [cite: 66]
        for (const b of placedBoxes) { if (overlaps(box, b)) { collide = true; break; [cite_start]} } [cite: 67]
        if (!collide) {
          [cite_start]placedBoxes.push(box); [cite: 68]
          [cite_start]const attachPx = L.point((off.x >= 0 ? box.x1 : box.x2), (off.y >= 0 ? box.y1 : box.y2)); [cite: 70]
          [cite_start]const attachLL = map.unproject(attachPx, map.getZoom()); [cite: 70]
          [cite_start]item.line.setLatLngs([baseLL, attachLL]); [cite: 71]
          [cite_start]return; [cite: 71]
        }
      }
      [cite_start]const lastOff = CANDIDATE_OFFSETS[CANDIDATE_OFFSETS.length - 1]; [cite: 72]
      [cite_start]const lastPx  = L.point(basePx.x + lastOff.x, basePx.y + lastOff.y); [cite: 72]
      [cite_start]const lastLL  = map.unproject(lastPx, map.getZoom()); [cite: 73]
      [cite_start]item.labelMarker.setLatLng(lastLL); [cite: 73]
      [cite_start]const lastBox = { x1: lastPx.x, y1: lastPx.y, x2: lastPx.x + size.w, y2: lastPx.y + size.h }; [cite: 74]
      [cite_start]placedBoxes.push(lastBox); [cite: 74]
      [cite_start]const fallbackAttachPx = L.point((lastOff.x >= 0 ? lastBox.x1 : lastBox.x2),(lastOff.y >= 0 ? lastBox.y1 : lastBox.y2)); [cite: 75]
      [cite_start]item.line.setLatLngs([baseLL, map.unproject(fallbackAttachPx, map.getZoom())]); [cite: 75]
    }

    [cite_start]let rafId = null; [cite: 76]
    function updateAllLabels() {
      [cite_start]if (rafId) cancelAnimationFrame(rafId); [cite: 77]
      rafId = requestAnimationFrame(() => {
        const placed = [];
        for (const it of labelItems) {
          if (!map.hasLayer(it.labelMarker)) continue;
          placeLabelFor(it, placed);
        [cite_start]} [cite: 78]
        toggleLabelsByZoom();
      [cite_start]}); [cite: 79]
    }

    function applyFilters() {
      [cite_start]const selDep  = selectedValues(document.getElementById('f-dep')); [cite: 82]
      [cite_start]const selProv = selectedValues(document.getElementById('f-prov')); [cite: 82]
      [cite_start]const selDist = selectedValues(document.getElementById('f-dist')); [cite: 82]
      [cite_start]const selRuta = selectedValues(document.getElementById('f-ruta')); [cite: 83]
      for (const it of labelItems) {
        const p = it.props || [cite_start]{}; [cite: 85]
        [cite_start]const okDep  = selDep.length  === 0 || selDep.includes(p.Departamentos); [cite: 86]
        [cite_start]const okProv = selProv.length === 0 || selProv.includes(p.Provincias); [cite: 86]
        [cite_start]const okDist = selDist.length === 0 || selDist.includes(p.Distritos); [cite: 86]
        [cite_start]const okRuta = selRuta.length === 0 || selRuta.includes(p.Ruta); [cite: 87]
        [cite_start]const visible = !!(okDep && okProv && okDist && okRuta); [cite: 88]
        if (visible) {
          [cite_start]if (!pointsLayer.hasLayer(it.marker)) it.marker.addTo(pointsLayer); [cite: 89]
          [cite_start]if (!labelsLayer.hasLayer(it.labelMarker)) it.labelMarker.addTo(labelsLayer); [cite: 89]
          [cite_start]if (!linesLayer.hasLayer(it.line)) it.line.addTo(linesLayer); [cite: 89]
        } else {
          [cite_start]if (pointsLayer.hasLayer(it.marker)) pointsLayer.removeLayer(it.marker); [cite: 90]
          [cite_start]if (labelsLayer.hasLayer(it.labelMarker)) labelsLayer.removeLayer(it.labelMarker); [cite: 90]
          [cite_start]if (linesLayer.hasLayer(it.line)) linesLayer.removeLayer(it.line); [cite: 90]
        }
      }
      if (polygonsLayer) {
        [cite_start]const withinZoom = map.getZoom() >= ZOOM_SHOW_POLYGONS; [cite: 91]
        polygonsLayer.eachLayer(layer => {
          const ruta = layer.feature?.properties?.Ruta;
          const passesRutaFilter = (selRuta.length === 0) || selRuta.includes(ruta);
          layer._visibleByFilter = passesRutaFilter;
          const shouldBeOn = withinZoom && passesRutaFilter;
          if (shouldBeOn) {
            [cite_start]if (!map.hasLayer(layer)) layer.addTo(map); [cite: 93]
          } else {
            [cite_start]if (map.hasLayer(layer)) map.removeLayer(layer); [cite: 94]
          }
        });
      }
      updateAllLabels();
    }

    function clearFilters() {
      for (const id of ['f-dep','f-prov','f-dist','f-ruta']) {
        const sel = document.getElementById(id);
        [cite_start]for (const opt of sel.options) opt.selected = false; [cite: 96]
      }
      [cite_start]applyFilters(); [cite: 97]
    }

    function toggleLabelsByZoom() {
      [cite_start]const show = map.getZoom() >= ZOOM_SHOW_LABELS; [cite: 102]
      if (show) {
        [cite_start]if (!map.hasLayer(labelsLayer)) map.addLayer(labelsLayer); [cite: 103]
        [cite_start]if (!map.hasLayer(linesLayer))  map.addLayer(linesLayer); [cite: 103]
      } else {
        [cite_start]if (map.hasLayer(labelsLayer)) map.removeLayer(labelsLayer); [cite: 104]
        [cite_start]if (map.hasLayer(linesLayer))  map.removeLayer(linesLayer); [cite: 104]
      }
    }

    function togglePolygonsByZoom() {
      if (!polygonsLayer) return;
      const show = map.getZoom() >= ZOOM_SHOW_POLYGONS;
      polygonsLayer.eachLayer(layer => {
        if (show && layer._visibleByFilter) {
          if (!map.hasLayer(layer)) layer.addTo(map);
        } else {
          if (map.hasLayer(layer)) map.removeLayer(layer);
        }
      });
    }

    function updateZoomIndicator() {
      document.getElementById('zoomLevel').textContent = map.getZoom();
    }

    function uniqueNonEmpty(arr) {
        return [...new Set(arr)].filter(Boolean).sort((a,b) => String(a).localeCompare(b));
    }

    function fillSelect(select, values) {
      select.innerHTML = '';
      for (const val of values) {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        select.appendChild(opt);
      }
    }

    function selectedValues(select) {
      return Array.from(select.selectedOptions).map(opt => opt.value);
    }
    
    document.getElementById('filterToggle').addEventListener('click', (e) => {
        const filters = document.querySelector('.filters');
        const isHidden = filters.classList.toggle('hidden');
        e.target.textContent = isHidden ? 'Mostrar filtros' : 'Ocultar filtros';
    });

    [cite_start]let userMarker = null, userCircle = null; [cite: 105]
    [cite_start]let following = false; [cite: 106]
    [cite_start]const locateBtn = document.getElementById('locateBtn'); [cite: 106]
    locateBtn.addEventListener('click', () => {
      [cite_start]following = !following; [cite: 108]
      locateBtn.title = following ? [cite_start]'Dejar de seguir mi ubicaci√≥n' : 'Seguir mi ubicaci√≥n'; [cite: 108]
      if (following) {
        map.once('locationfound', (e) => {
          map.setView(e.latlng, Math.max(map.getZoom(), 17));
        [cite_start]}); [cite: 109]
        [cite_start]map.locate({ setView: false, watch: true, enableHighAccuracy: true, maxZoom: 18 }); [cite: 109]
      } else {
        [cite_start]map.stopLocate(); [cite: 110]
      }
    [cite_start]}); [cite: 108]
    map.on('locationfound', (e) => {
      [cite_start]const { latlng, accuracy } = e; [cite: 111]
      const blueCircleIcon = L.divIcon({
        className: '',
        [cite_start]html: '<div style="width:20px;height:20px;background:#005af0;border:5px solid white;border-radius:50%;"></div>', [cite: 112]
        [cite_start]iconSize: [20, 20], [cite: 112]
        [cite_start]iconAnchor: [10, 10] [cite: 112]
      });
      if (!userMarker) {
        [cite_start]userMarker = L.marker(latlng, { icon: blueCircleIcon }).addTo(map); [cite: 113]
      } else {
        [cite_start]userMarker.setLatLng(latlng); [cite: 113]
      }
      if (!userCircle) {
        [cite_start]userCircle = L.circle(latlng, { radius: accuracy, color: '#3388ff', weight: 1, fillOpacity: 0.15 }).addTo(map); [cite: 114]
      } else {
        [cite_start]userCircle.setLatLng(latlng); [cite: 115]
        [cite_start]userCircle.setRadius(accuracy); [cite: 115]
      }
      [cite_start]if (following) map.panTo(latlng); [cite: 116]
    });
    map.on('locationerror', () => {
      alert('No fue posible obtener tu ubicaci√≥n. Verifica permisos del navegador.');
    [cite_start]}); [cite: 117]
  } // <-- FIN de la funci√≥n initMap
</script>
</body>
</html>
